var watchingWorksJson,searchWorksJson,version=1,api=new function(){var e=function(e,t,i){var a=function(e,a){var o={query:t.replace(spaceReg," ")};i&&(o.variables=i),$.ajax({url:"https://api.annict.com/graphql",type:"POST",contentType:"application/json",dataType:"json",headers:{Authorization:"bearer "+e},data:JSON.stringify(o),success:a,error:function(e){var t="";if(e.responseText){t=": ";try{var i=JSON.parse(e.responseText);i.message&&(t+=i.message)}catch(i){t+=e.responseText}}alertMessage("Graphql API のリクエストでエラーが発生しました。 ("+e.status+t+")","danger",5e3)}})},o=sessionStorage.getItem("token");o||(o=localStorage.getItem("token")),o?a(o,e):($("#token-modal-ok").unbind("click").bind("click",function(){var t=$("#token").val();if(t){var i=$('[name="storage"]:checked').val();a(t,function(a){sessionStorage.removeItem("token"),localStorage.removeItem("token"),"session"==i?sessionStorage.setItem("token",t):"local"==i&&localStorage.setItem("token",t),e&&e(a)})}else alertMessage("アクセストークンを入力してください。","danger");$("#token-modal").modal("hide")}),$("#token-modal").modal())};this.watchingWorks=function(t,i){var a={episodeAnnictIds:i,withEpisodes:i.length>0};e(t,"query($episodeAnnictIds: [Int!], $withEpisodes: Boolean!) { viewer { works(state: WATCHING) { nodes { id annictId title titleKana episodes(orderBy: {field: SORT_NUMBER, direction: ASC}, first: 1) { nodes { id annictId numberText title viewerDidTrack } } } } } searchEpisodes(annictIds: $episodeAnnictIds) @include(if: $withEpisodes) { nodes { id annictId numberText title viewerDidTrack work { annictId } } } }",a)},this.prevEpisode=function(t,i,a){e(t,"query($id: Int!, $skip: Boolean!) { searchEpisodes(annictIds: [$id]) { nodes { prevEpisode { ...episodeFields prevEpisode @include(if: $skip) { ...episodeFields prevEpisode { ...episodeFields prevEpisode { ...episodeFields prevEpisode { ...episodeFields } } } } } work { episodes(orderBy: {field: SORT_NUMBER, direction: DESC}, first: 1) { nodes { ...episodeFields } } } } } } fragment episodeFields on Episode { id annictId numberText title viewerDidTrack }",{id:i,skip:a})},this.nextEpisode=function(t,i,a){e(t,"query($id: Int!, $skip: Boolean!) { searchEpisodes(annictIds: [$id]) { nodes { nextEpisode { ...episodeFields nextEpisode @include(if: $skip) { ...episodeFields nextEpisode { ...episodeFields nextEpisode { ...episodeFields nextEpisode { ...episodeFields } } } } } work { episodes(orderBy: {field: SORT_NUMBER, direction: ASC}, first: 1) { nodes { ...episodeFields } } } } } } fragment episodeFields on Episode { id annictId numberText title viewerDidTrack }",{id:i,skip:a})},this.createReview=function(t,i,a,o,s,n,r,d,c,l){var p={id:i,body:a};o&&(p.overall=o),s&&(p.animation=s),n&&(p.music=n),r&&(p.story=r),d&&(p.character=d),c&&(p.twitter=c),l&&(p.facebook=l),e(t,"mutation($id: ID!, $body: String!, $overall: RatingState, $animation: RatingState, $music: RatingState, $story: RatingState, $character: RatingState, $twitter: Boolean, $facebook: Boolean) { createReview(input: {workId: $id, body: $body, ratingOverallState: $overall, ratingAnimationState: $animation, ratingMusicState: $music, ratingStoryState: $story, ratingCharacterState: $character, shareTwitter: $twitter, shareFacebook: $facebook}) { review { work { title } } } }",p)},this.createRecord=function(t,i,a,o,s,n){var r={id:i};a&&(r.rating=a),o&&(r.comment=o),s&&(r.twitter=s),n&&(r.facebook=n),e(t,"mutation($id: ID!, $rating: RatingState, $comment: String, $twitter: Boolean, $facebook: Boolean) { createRecord(input: {episodeId: $id, ratingState: $rating, comment: $comment, shareTwitter: $twitter, shareFacebook: $facebook}) { record { episode { id annictId numberText title viewerDidTrack } } } }",r)},this.updateStatus=function(t,i,a){var o={id:i,state:state};e(t,"mutation($id: ID!, $state: StatusState!) { updateStatus(input: {workId: $id, state: $state}) { work { id annictId title titleKana episodes(first: 1, orderBy: {field: SORT_NUMBER, direction: ASC}) { nodes { id annictId numberText title viewerDidTrack } } } } } ",o)},this.searchWorks=function(t,i,a,o){var s={titles:i,before:a,after:o};a?s.last=20:s.first=20,e(t,"query($titles: [String!]!, $before: String, $after: String, $first: Int, $last: Int) { searchWorks(titles: $titles, orderBy: {field: SEASON, direction: DESC}, before: $before, after: $after, first: $first, last: $last) { nodes { id annictId title titleKana viewerStatusState } pageInfo { startCursor endCursor hasPreviousPage hasNextPage } } }",s)}},spaceReg=/[\s　]+/g;function updateWatchingWorksJson(e){api.watchingWorks(function(t){if(t.data.searchEpisodes){var i=t.data.viewer.works.nodes;t.data.searchEpisodes.nodes.forEach(function(e){for(var t=e.work.annictId,a=0;a<i.length;a++)if(i[a].annictId==t){delete e.work,i[a].episodes.nodes=[e];break}}),delete t.data.searchEpisodes}watchingWorksJson=t,saveWatchingWorksJson(),e()},watchingWorksJson.episodeAnnictIds)}function loadWatchingWorksJson(){var e=localStorage.getItem("watchingWorks");watchingWorksJson=e?JSON.parse(e):{data:{viewer:{works:{nodes:[]}}},episodeAnnictIds:[],version:version}}var altReg=/^ゔ[ぁぃぅぇぉ]?|^ヴ[ァィゥェォ]?/,altDic={"ゔぁ":"ば","ゔぃ":"び","ゔ":"ぶ","ゔぅ":"ぶ","ゔぇ":"べ","ゔぉ":"ぼ","ヴァ":"バ","ヴィ":"ビ","ヴ":"ブ","ヴゥ":"ブ","ヴェ":"ベ","ヴォ":"ボ"},altRep=function(e){return altDic[e]};function saveWatchingWorksJson(){watchingWorksJson.data.viewer.works.nodes.sort(function(e,t){var i=e.titleKana?e.titleKana.replace(altReg,altRep):e.title.replace(altReg,altRep),a=t.titleKana?t.titleKana.replace(altReg,altRep):t.title.replace(altReg,altRep);return i<a?-1:i>a?1:0}),watchingWorksJson.episodeAnnictIds=[],watchingWorksJson.data.viewer.works.nodes.forEach(function(e){var t=e.episodes.nodes;t.length>0&&watchingWorksJson.episodeAnnictIds.push(t[0].annictId)}),watchingWorksJson.version=version,setTimeout(function(){localStorage.setItem("watchingWorks",JSON.stringify(watchingWorksJson))},0)}function addWatchingWorksJson(e){for(var t=watchingWorksJson.data.viewer.works.nodes,i=0;i<t.length;i++)if(t[i].annictId==e.annictId)return!1;return watchingWorksJson.data.viewer.works.nodes.push(e),saveWatchingWorksJson(),!0}function removeWatchingWorksJson(e){for(var t=watchingWorksJson.data.viewer.works.nodes,i=0;i<t.length;i++)if(t[i].annictId==e)return t.splice(i,1),saveWatchingWorksJson(),!0;return!1}function loadSearchWorksJson(){var e=localStorage.getItem("searchWorks");searchWorksJson=e?JSON.parse(e):{data:{searchWorks:{nodes:[],pageInfo:{hasPreviousPage:!1,hasNextPage:!1}}},title:"",version:version}}function saveSearchWorksJson(){searchWorksJson.version=version,setTimeout(function(){localStorage.setItem("searchWorks",JSON.stringify(searchWorksJson))},0)}function clearSearchWorksJson(){localStorage.removeItem("searchWorks"),loadSearchWorksJson(),saveSearchWorksJson()}function clearStorage(){localStorage.clear(),sessionStorage.clear()}function alertMessage(e,t,i){var a=$("#alert"),o=a.find("#alert-bg"),s=o.data("bg"),n="bg-"+t;o.removeClass(s).addClass(n).data("bg",n),a.find("#alert-message").text(e),a.show("fast",function(){setTimeout(function(){a.click()},i||2500)})}$(function(){$("#alert").click(function(){$(this).hide("fast")})}),loadWatchingWorksJson();