var watchingWorksJson,searchWorksJson,version=1,api=new function(){var e="https://api.annict.com/graphql",t=20,o=/[\s　]+/g,s="id annictId title titleKana ",a="id annictId numberText title viewerDidTrack ",i="query($episodeAnnictIds: [Int!], $withEpisodes: Boolean!) { viewer { works(state: WATCHING) { nodes { "+s+"episodes(orderBy: {field: SORT_NUMBER, direction: ASC}, first: 1) { nodes { "+a+"} } } } } searchEpisodes(annictIds: $episodeAnnictIds) @include(if: $withEpisodes) { nodes { "+a+"work { annictId } } } }",n="query($id: Int!, $skip: Boolean!) { searchEpisodes(annictIds: [$id]) { nodes { nextEpisode { ...episodeFields nextEpisode @include(if: $skip) { ...episodeFields nextEpisode { ...episodeFields nextEpisode { ...episodeFields nextEpisode { ...episodeFields } } } } } work { episodes(orderBy: {field: SORT_NUMBER, direction: ASC}, first: 1) { nodes { ...episodeFields } } } } } } fragment episodeFields on Episode { "+a+"}",r="query($id: Int!, $skip: Boolean!) { searchEpisodes(annictIds: [$id]) { nodes { prevEpisode { ...episodeFields prevEpisode @include(if: $skip) { ...episodeFields prevEpisode { ...episodeFields prevEpisode { ...episodeFields prevEpisode { ...episodeFields } } } } } work { episodes(orderBy: {field: SORT_NUMBER, direction: DESC}, first: 1) { nodes { ...episodeFields } } } } } } fragment episodeFields on Episode { "+a+"}",d="mutation($id: ID!, $rating: RatingState, $comment: String, $twitter: Boolean, $facebook: Boolean) { createRecord(input: {episodeId: $id, ratingState: $rating, comment: $comment, shareTwitter: $twitter, shareFacebook: $facebook}) { record { episode { "+a+"} } } }",c="mutation($id: ID!, $body: String!, $overall: RatingState, $animation: RatingState, $music: RatingState, $story: RatingState, $character: RatingState, $twitter: Boolean, $facebook: Boolean) { createReview(input: {workId: $id, body: $body, ratingOverallState: $overall, ratingAnimationState: $animation, ratingMusicState: $music, ratingStoryState: $story, ratingCharacterState: $character, shareTwitter: $twitter, shareFacebook: $facebook}) { review { work { title } } } }",l="mutation($id: ID!, $state: StatusState!) { updateStatus(input: {workId: $id, state: $state}) { work { "+s+"episodes(first: 1, orderBy: {field: SORT_NUMBER, direction: ASC}) { nodes { "+a+"} } } } } ",g="query($titles: [String!]!, $before: String, $after: String, $first: Int, $last: Int) { searchWorks(titles: $titles, orderBy: {field: SEASON, direction: DESC}, before: $before, after: $after, first: $first, last: $last) { nodes { "+s+"viewerStatusState } pageInfo { startCursor endCursor hasPreviousPage hasNextPage } } }",h=function(t,s,a){var i=function(t,i){var n={query:s.replace(o," ")};a&&(n.variables=a),$.ajax({url:e,type:"POST",contentType:"application/json",dataType:"json",headers:{Authorization:"bearer "+t},data:JSON.stringify(n),success:i,error:function(e){var t="";if(e.responseText){t=": ";try{var o=JSON.parse(e.responseText);o.message&&(t+=o.message)}catch(o){t+=e.responseText}}alertMessage("Graphql API のリクエストでエラーが発生しました。 ("+e.status+t+")","danger",5e3)}})},n=sessionStorage.getItem("token");n||(n=localStorage.getItem("token")),n?i(n,t):($("#token-modal-ok").unbind("click").bind("click",function(){var e=$("#token").val();if(e){var o=$('[name="storage"]:checked').val();i(e,function(s){sessionStorage.removeItem("token"),localStorage.removeItem("token"),"session"==o?sessionStorage.setItem("token",e):"local"==o&&localStorage.setItem("token",e),t&&t(s)})}else alertMessage("アクセストークンを入力してください。","danger");$("#token-modal").modal("hide")}),$("#token-modal").modal())};this.watchingWorks=function(e,t){var o={episodeAnnictIds:t,withEpisodes:t.length>0};h(e,i,o)},this.prevEpisode=function(e,t,o){h(e,r,{id:t,skip:o})},this.nextEpisode=function(e,t,o){h(e,n,{id:t,skip:o})},this.createReview=function(e,t,o,s,a,i,n,r,d,l){var g={id:t,body:o};s&&(g.overall=s),a&&(g.animation=a),i&&(g.music=i),n&&(g.story=n),r&&(g.character=r),d&&(g.twitter=d),l&&(g.facebook=l),h(e,c,g)},this.createRecord=function(e,t,o,s,a,i){var n={id:t};o&&(n.rating=o),s&&(n.comment=s),a&&(n.twitter=a),i&&(n.facebook=i),h(e,d,n)},this.updateStatus=function(e,t,o){h(e,l,{id:t,state:o})},this.searchWorks=function(e,s,a,i){var n=s.split(o);if(0!=n.length&&n[0]){var r={titles:n,before:a,after:i};a?r.last=t:r.first=t,h(e,g,r)}else alertMessage("タイトルを入力してください。","danger")}},TitleNormalizer=$.extend(function(e){this.work=e,this.normalize()}.prototype,{katakanaRegExp:/[ァ-ヶ]/g,altRegExp:/^ゔ[ぁぃぅぇぉ]?/,altHash:{"ゔぁ":"ば","ゔぃ":"び","ゔ":"ぶ","ゔぅ":"ぶ","ゔぇ":"べ","ゔぉ":"ぼ"},normalize:function(){this.work.titleKana||(this.work.titleKana=this.work.title.replace(this.katakanaRegExp,this.toHiragana)),this.work.titleKana=this.work.titleKana.replace(this.altRegExp,this.alternate)},toHiragana:function(e){var t=e.charCodeAt(0)-96;return String.fromCharCode(t)},alternate:function(e){return this.altHash[e]},getKana:function(){return this.work.titleKana},compare:function(e){var t=this.getKana(),o=e.getKana();return t<o?-1:t>o?1:0}}).constructor;function updateWatchingWorksJson(e){api.watchingWorks(function(t){if(t.data.searchEpisodes){var o=t.data.viewer.works.nodes;t.data.searchEpisodes.nodes.forEach(function(e){for(var t=e.work.annictId,s=0;s<o.length;s++)if(o[s].annictId==t){delete e.work,o[s].episodes.nodes=[e];break}}),delete t.data.searchEpisodes}watchingWorksJson=t,saveWatchingWorksJson(),e()},watchingWorksJson.episodeAnnictIds)}function loadWatchingWorksJson(){var e=localStorage.getItem("watchingWorks");watchingWorksJson=e?JSON.parse(e):{data:{viewer:{works:{nodes:[]}}},episodeAnnictIds:[],version:version}}function saveWatchingWorksJson(){watchingWorksJson.data.viewer.works.nodes.sort(function(e,t){return new TitleNormalizer(e).compare(new TitleNormalizer(t))}),watchingWorksJson.episodeAnnictIds=[],watchingWorksJson.data.viewer.works.nodes.forEach(function(e){var t=e.episodes.nodes;t.length>0&&watchingWorksJson.episodeAnnictIds.push(t[0].annictId)}),watchingWorksJson.version=version,setTimeout(function(){localStorage.setItem("watchingWorks",JSON.stringify(watchingWorksJson))},0)}function addWatchingWorksJson(e){for(var t=watchingWorksJson.data.viewer.works.nodes,o=0;o<t.length;o++)if(t[o].annictId==e.annictId)return!1;return watchingWorksJson.data.viewer.works.nodes.push(e),saveWatchingWorksJson(),!0}function removeWatchingWorksJson(e){for(var t=watchingWorksJson.data.viewer.works.nodes,o=0;o<t.length;o++)if(t[o].annictId==e)return t.splice(o,1),saveWatchingWorksJson(),!0;return!1}function loadSearchWorksJson(){var e=localStorage.getItem("searchWorks");searchWorksJson=e?JSON.parse(e):{data:{searchWorks:{nodes:[],pageInfo:{hasPreviousPage:!1,hasNextPage:!1}}},title:"",version:version}}function saveSearchWorksJson(){searchWorksJson.version=version,setTimeout(function(){localStorage.setItem("searchWorks",JSON.stringify(searchWorksJson))},0)}function clearSearchWorksJson(){localStorage.removeItem("searchWorks"),loadSearchWorksJson(),saveSearchWorksJson()}function clearStorage(){localStorage.clear(),sessionStorage.clear()}function alertMessage(e,t,o){var s=$("#alert"),a=s.find("#alert-bg"),i=a.data("bg"),n="bg-"+t;a.removeClass(i).addClass(n).data("bg",n),s.find("#alert-message").text(e),s.show("fast",function(){setTimeout(function(){s.click()},o||2500)})}$(function(){$("#alert").click(function(){$(this).hide("fast")})}),loadWatchingWorksJson();