var version=1,StorageCache=$.extend($.extend(function(e){this.key=e,this.useLocalStorage()}.prototype,{get:function(){return this.storage.getItem(this.key)},set:function(e){this.storage.setItem(this.key,e)},remove:function(){this.storage.removeItem(this.key)},useLocalStorage:function(){return this.storage=localStorage,this},useSessionStorage:function(){return this.storage=sessionStorage,this}}).constructor,{clear:function(){sessionStorage.clear(),localStorage.clear()}}),JsonCache=Object.setPrototypeOf($.extend(function(e){StorageCache.call(this,e),this.load()}.prototype,{get:function(e){return this.item},set:function(e){this.item=e},remove:function(){StorageCache.prototype.remove.call(this),this.item=this.getDefault()},load:function(){var e=StorageCache.prototype.get.call(this);if(e)try{return void(this.item=JSON.parse(e))}catch(e){}this.item=this.getDefault()},save:function(){this.item.version=version,setTimeout(function(){StorageCache.prototype.set.call(this,JSON.stringify(this.item))}.bind(this),0)},getDefault:function(){return{}}}),StorageCache.prototype).constructor,api=new function(){var e="https://api.annict.com/graphql",t=20,i=/[\s　]+/g,a="id annictId title titleKana ",o="id annictId numberText title viewerDidTrack ",s="query($episodeAnnictIds: [Int!], $withEpisodes: Boolean!) { viewer { works(state: WATCHING) { nodes { "+a+"episodes(orderBy: {field: SORT_NUMBER, direction: ASC}, first: 1) { nodes { "+o+"} } } } } searchEpisodes(annictIds: $episodeAnnictIds) @include(if: $withEpisodes) { nodes { "+o+"work { annictId } } } }",r="query($id: Int!, $skip: Boolean!) { searchEpisodes(annictIds: [$id]) { nodes { nextEpisode { ...episodeFields nextEpisode @include(if: $skip) { ...episodeFields nextEpisode { ...episodeFields nextEpisode { ...episodeFields nextEpisode { ...episodeFields } } } } } work { episodes(orderBy: {field: SORT_NUMBER, direction: ASC}, first: 1) { nodes { ...episodeFields } } } } } } fragment episodeFields on Episode { "+o+"}",n="query($id: Int!, $skip: Boolean!) { searchEpisodes(annictIds: [$id]) { nodes { prevEpisode { ...episodeFields prevEpisode @include(if: $skip) { ...episodeFields prevEpisode { ...episodeFields prevEpisode { ...episodeFields prevEpisode { ...episodeFields } } } } } work { episodes(orderBy: {field: SORT_NUMBER, direction: DESC}, first: 1) { nodes { ...episodeFields } } } } } } fragment episodeFields on Episode { "+o+"}",d="mutation($id: ID!, $rating: RatingState, $comment: String, $twitter: Boolean, $facebook: Boolean) { createRecord(input: {episodeId: $id, ratingState: $rating, comment: $comment, shareTwitter: $twitter, shareFacebook: $facebook}) { record { episode { "+o+"} } } }",c="mutation($id: ID!, $body: String!, $overall: RatingState, $animation: RatingState, $music: RatingState, $story: RatingState, $character: RatingState, $twitter: Boolean, $facebook: Boolean) { createReview(input: {workId: $id, body: $body, ratingOverallState: $overall, ratingAnimationState: $animation, ratingMusicState: $music, ratingStoryState: $story, ratingCharacterState: $character, shareTwitter: $twitter, shareFacebook: $facebook}) { review { work { title } } } }",l="mutation($id: ID!, $state: StatusState!) { updateStatus(input: {workId: $id, state: $state}) { work { "+a+"episodes(first: 1, orderBy: {field: SORT_NUMBER, direction: ASC}) { nodes { "+o+"} } } } } ",p="query($titles: [String!]!, $before: String, $after: String, $first: Int, $last: Int) { searchWorks(titles: $titles, orderBy: {field: SEASON, direction: DESC}, before: $before, after: $after, first: $first, last: $last) { nodes { "+a+"viewerStatusState } pageInfo { startCursor endCursor hasPreviousPage hasNextPage } } }",u=new StorageCache("token"),h=function(t,a,o){var s=function(t,s){var r={query:a.replace(i," ")};o&&(r.variables=o),$.ajax({url:e,type:"POST",contentType:"application/json",dataType:"json",headers:{Authorization:"bearer "+t},data:JSON.stringify(r),success:s,error:function(e){var t="";if(e.responseText){t=": ";try{var i=JSON.parse(e.responseText);i.message&&(t+=i.message)}catch(i){t+=e.responseText}}alertMessage("Graphql API のリクエストでエラーが発生しました。 ("+e.status+t+")","danger",5e3)}})},r=u.useLocalStorage().get();r||(r=u.useSessionStorage().get()),r?s(r,t):($("#token-modal-ok").unbind("click").bind("click",function(){var e=$("#token").val();if(e){var i=$('[name="storage"]:checked').val();s(e,function(a){"session"==i?u.useSessionStorage().set(e):"local"==i&&u.useLocalStorage().set(e),t(a)})}else alertMessage("アクセストークンを入力してください。","danger");$("#token-modal").modal("hide")}),$("#token-modal").modal())};this.watchingWorks=function(e,t){var i={episodeAnnictIds:t,withEpisodes:t.length>0};h(e,s,i)},this.prevEpisode=function(e,t,i){h(e,n,{id:t,skip:i})},this.nextEpisode=function(e,t,i){h(e,r,{id:t,skip:i})},this.createReview=function(e,t,i,a,o,s,r,n,d,l){var p={id:t,body:i};a&&(p.overall=a),o&&(p.animation=o),s&&(p.music=s),r&&(p.story=r),n&&(p.character=n),d&&(p.twitter=d),l&&(p.facebook=l),h(e,c,p)},this.createRecord=function(e,t,i,a,o,s){var r={id:t};i&&(r.rating=i),a&&(r.comment=a),o&&(r.twitter=o),s&&(r.facebook=s),h(e,d,r)},this.updateStatus=function(e,t,i){h(e,l,{id:t,state:i})},this.searchWorks=function(e,a,o,s){var r=a.split(i);if(0!=r.length&&r[0]){var n={titles:r,before:o,after:s};o?n.last=t:n.first=t,h(e,p,n)}else alertMessage("タイトルを入力してください。","danger")}},TitleNormalizer=$.extend(function(e){this.work=e,this.normalize()}.prototype,{katakanaRegExp:/[ァ-ヶ]/g,altRegExp:/^ゔ[ぁぃぅぇぉ]?/,altHash:{"ゔぁ":"ば","ゔぃ":"び","ゔ":"ぶ","ゔぅ":"ぶ","ゔぇ":"べ","ゔぉ":"ぼ"},normalize:function(){this.work.titleKana||(this.work.titleKana=this.work.title.replace(this.katakanaRegExp,this.toHiragana)),this.work.titleKana=this.work.titleKana.replace(this.altRegExp,this.alternate)},toHiragana:function(e){var t=e.charCodeAt(0)-96;return String.fromCharCode(t)},alternate:function(e){return this.altHash[e]},getKana:function(){return this.work.titleKana},compare:function(e){var t=this.getKana(),i=e.getKana();return t<i?-1:t>i?1:0}}).constructor;function alertMessage(e,t,i){var a=$("#alert"),o=a.find("#alert-bg"),s=o.data("bg"),r="bg-"+t;o.removeClass(s).addClass(r).data("bg",r),a.find("#alert-message").text(e),a.show("fast",function(){setTimeout(function(){a.click()},i||2500)})}$(function(){$("#alert").click(function(){$(this).hide("fast")})});