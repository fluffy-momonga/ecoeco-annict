var watchingContent=new function(){var e=new(Object.setPrototypeOf($.extend(function(e){JsonCache.call(this,e)}.prototype,{save:function(){var e=this.get();e.data.viewer.works.nodes.sort(function(e,t){return new TitleNormalizer(e).compare(new TitleNormalizer(t))}),e.episodeAnnictIds=[],e.data.viewer.works.nodes.forEach(function(t){var i=t.episodes.nodes;i.length>0&&e.episodeAnnictIds.push(i[0].annictId)}),JsonCache.prototype.save.call(this)},getDefault:function(){return{data:{viewer:{works:{nodes:[]}}},episodeAnnictIds:[],version:version}}}),JsonCache.prototype).constructor)("watchingWorks"),t=new StorageCache("twitter"),i=new StorageCache("facebook"),n=0,r=function(e){var t=annict.makeWorkPageUrl(e.annictId),i=$("#group-template .work-heading").clone(!0,!0);return i.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),i.find(".work-link").attr("href",t).text(e.title),i},o=function(e,t){var i=$("#group-template .episode-body").clone(!0,!0);if(!e)return i.empty();i.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var n=annict.makeEpisodePageUrl(t.annictId,e.annictId),r=i.find(".episode-record"),o=i.find(".episode-title").text(e.title?e.title:"");return i.find(".episode-link").attr("href",n),i.find(".episode-number").text(e.numberText),e.viewerDidTrack?r.attr("disabled","disabled"):o.hide(),i},a=[{title:"あ",initial:"A",reg:/^[ぁ-お]/,works:[]},{title:"か",initial:"K",reg:/^[か-ご]/,works:[]},{title:"さ",initial:"S",reg:/^[さ-ぞ]/,works:[]},{title:"た",initial:"T",reg:/^[た-ど]/,works:[]},{title:"な",initial:"N",reg:/^[な-の]/,works:[]},{title:"は",initial:"H",reg:/^[は-ぽ]/,works:[]},{title:"ま",initial:"M",reg:/^[ま-も]/,works:[]},{title:"や",initial:"Y",reg:/^[ゃ-よ]/,works:[]},{title:"ら",initial:"R",reg:/^[ら-ろ]/,works:[]},{title:"わ",initial:"W",reg:/^[ゎ-ん]/,works:[]},{title:"他",initial:"O",reg:/^./,works:[]}],d=function(){e.get().data.viewer.works.nodes.forEach(function(e){for(var t=new TitleNormalizer(e),i=0;i<a.length;i++)if(a[i].reg.test(t.getKana())){a[i].works.push(e);break}});var t=$("#watching-works").empty();a.forEach(function(e){var i=e.works.length>0;if(headerContent.toggleInitial(e.initial,i),i){var n=$("#group-template .group-heading, #group-template .group-body").clone(!1,!1),a=n.find(".works");for(n.filter(".group-heading").attr("data-initial",e.initial),n.find(".group-title").text(e.title),a.empty(),t.append(n);e.works.length>0;){var d=e.works.shift(),c=d.episodes.nodes.length>0?d.episodes.nodes[0]:null,s=r(d),l=o(c,d);a.append(s,l)}}})},c=function(t,i){for(var n=i.filter(".work-heading").data("annict-id"),r=e.get().data.viewer.works.nodes,a=0;a<r.length;a++)if(r[a].annictId==n){r[a].episodes.nodes[0]=t,e.save();var d=o(t,r[a]);i.filter(".episode-body").remove(),i.filter(".work-heading").after(d);break}},s=function(t){annict.watchingWorks(function(i){if(i.data.searchEpisodes){var n=i.data.viewer.works.nodes;i.data.searchEpisodes.nodes.forEach(function(e){for(var t=e.work.annictId,i=0;i<n.length;i++)if(n[i].annictId==t){delete e.work,n[i].episodes.nodes=[e];break}}),delete i.data.searchEpisodes}e.set(i),e.save(),t()},e.get().episodeAnnictIds)},l=function(t){for(var i=e.get().data.viewer.works.nodes,n=0;n<i.length;n++)if(i[n].id==t)return i.splice(n,1),e.save(),!0;return!1},f=function(e,t){var i=t.get();e.prop("checked","true"==i)},p=function(e,t){var i=e.prop("checked");return t.set(i),i},v=function(e,t,i,n){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),r=e.filter(".episode-body").data("annict-id");t(function(t){var n=function(e,t){var i=e[t];if(i){for(;i[t];)i=i[t];return i}return e.work.episodes.nodes[0]}(t.data.searchEpisodes.nodes[0],i);c(n,e)},r,n)})},u=function(e,t,i){e.click(function(){var e=$(this).closest(".work-heading"),n=e.data("id"),r=e.find(".work-link").text();$("#status-modal-title").text(r),$("#status-modal-name").text(i),$("#status-modal-ok").data("id",n).data("state",t).text(i),$("#status-modal").modal()})},w=function(e){var n;u(e.find(".work-watched"),"WATCHED","見た"),u(e.find(".work-hold"),"ON_HOLD","一時中断"),u(e.find(".work-stop"),"STOP_WATCHING","視聴中止"),$("#status-modal-ok").click(function(){var e=$(this).data("id"),t=$(this).data("state");$("#status-modal").modal("hide"),annict.updateStatus(function(i){l(e);var n=$('#watching-works .work-heading[data-id="'+e+'"]'),r=n.closest(".works");if(n.next(".episode-body").remove(),n.remove(),0==r.find(".work-heading").length){var o=r.closest(".group-body"),a=o.prev(".group-heading"),d=a.data("initial");a.remove(),o.remove(),headerContent.toggleInitial(d,!1)}searchContent.updateWorkStatus(e,t),headerContent.inform("変更しました。","info")},e,t)}),e.find(".work-review").click(function(){var e=$(this).closest(".work-heading"),r=e.find(".work-link").text();n=e.data("id"),$("#review-work-title").text(r),$('[name^="review-rating-"][value=""]').click(),$("#review-body").val(""),f($("#review-twitter"),t),f($("#review-facebook"),i),$("#review-modal").modal()}),$("#review-modal-ok").click(function(){var e=$('[name="review-rating-overall"]:checked').val(),r=$('[name="review-rating-animation"]:checked').val(),o=$('[name="review-rating-music"]:checked').val(),a=$('[name="review-rating-story"]:checked').val(),d=$('[name="review-rating-character"]:checked').val(),c=$("#review-body").val(),s=p($("#review-twitter"),t),l=p($("#review-facebook"),i);$("#review-modal").modal("hide"),annict.createReview(function(e){headerContent.inform("記録しました。","info")},n,c,e,r,o,a,d,s,l)}),function(e){var n,r;e.click(function(){n=$(this).closest(".episode-body").prev(".work-heading").andSelf(),r=n.filter(".episode-body").data("id");var e=n.find(".work-link").text(),o=n.find(".episode-number").text(),a=n.find(".episode-title").text();$("#record-work-title").text(e),$("#record-episode-number").text(o),$("#record-episode-title").text(a),$('[name="record-rating"][value=""]').click(),$("#record-comment").val(""),f($("#record-twitter"),t),f($("#record-facebook"),i),$("#record-modal").modal()}),$("#record-modal-ok").click(function(){var e=$('[name="record-rating"]:checked').val(),o=$("#record-comment").val(),a=p($("#record-twitter"),t),d=p($("#record-facebook"),i);$("#record-modal").modal("hide"),annict.createRecord(function(e){var t=e.data.createRecord.record.episode;c(t,n),headerContent.inform("記録しました。","info")},r,e,o,a,d)})}(e.find(".episode-record")),v(e.find(".episode-skip-prev"),annict.prevEpisode,"prevEpisode",!0),v(e.find(".episode-prev"),annict.prevEpisode,"prevEpisode",!1),v(e.find(".episode-next"),annict.nextEpisode,"nextEpisode",!1),v(e.find(".episode-skip-next"),annict.nextEpisode,"nextEpisode",!0),$("#update").click(function(){s(function(){d(),headerContent.inform("更新しました。","info")})}),$("#clear").click(function(){StorageCache.clear(),watchingContent.clear(),searchContent.clear(),headerContent.inform("クリアしました。","info")})};this.addWork=function(t){(function(t){for(var i=e.get().data.viewer.works.nodes,n=0;n<i.length;n++)if(i[n].annictId==t.annictId)return!1;return i.push(t),e.save(),!0})(t)&&d()},this.removeWork=function(e){l(e)&&d()},this.getGroups=function(){return a},this.getGroupTop=function(e){var t=$("#watching-works");return n||(n=t.find(".group-heading:first").offset().top),t.find('.group-heading[data-initial="'+e+'"]').offset().top-n},this.clear=function(){e.remove(),d()},this.build=function(){var t;w($("#group-template")),t=$("#rating-template > *").clone(!1,!1),$(".rating").append(t).each(function(){var e=$(this).data("name");$(this).find("input").attr("name",e)}),e.get().version!=version?s(function(){d()}):d()}};$(function(){watchingContent.build()});