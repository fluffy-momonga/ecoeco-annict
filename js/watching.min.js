function clearWatchingWorks(){$("#watching-works").empty()}function getWorkHeading(e){var t="https://annict.jp/works/"+e.annictId,i=$("#group-template .work-heading").clone(!0,!0);return i.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),i.find(".work-link").attr("href",t).text(e.title),i}function getEpisodeBody(e,t){var i=$("#group-template .episode-body").clone(!0,!0);if(!e)return i.empty();i.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var r="https://annict.jp/works/"+t.annictId+"/episodes/"+e.annictId,o=i.find(".episode-record"),n=(i.find(".episode-link").attr("href",r),i.find(".episode-number").text(e.numberText),i.find(".episode-title").text(e.title?e.title:""));return e.viewerDidTrack?o.prop("disabled",!0):n.hide(),i}var groupList=[{title:"あ",reg:/^[ぁ-お]/,works:[]},{title:"か",reg:/^[か-ご]/,works:[]},{title:"さ",reg:/^[さ-ぞ]/,works:[]},{title:"た",reg:/^[た-ど]/,works:[]},{title:"な",reg:/^[な-の]/,works:[]},{title:"は",reg:/^[は-ぽゔ]/,works:[]},{title:"ま",reg:/^[ま-も]/,works:[]},{title:"や",reg:/^[ゃ-よ]/,works:[]},{title:"ら",reg:/^[ら-ろ]/,works:[]},{title:"わ",reg:/^[ゎ-ん]/,works:[]},{title:"他",reg:/^./,works:[]}];function renderWatchingWorks(){clearWatchingWorks(),watchingWorksJson.data.viewer.works.nodes.forEach(function(e){for(var t=0;t<groupList.length;t++)if(groupList[t].reg.test(e.titleKana)){groupList[t].works.push(e);break}});var e=$("#watching-works");groupList.forEach(function(t){if(t.works.length>0){var i=$("#group-template .group-heading, #group-template .group-body").clone(!1,!1),r=i.find(".works");for(i.find(".group-title").text(t.title),r.empty(),e.append(i);t.works.length>0;){var o=t.works.shift(),n=o.episodes.nodes.length>0?o.episodes.nodes[0]:null,s=getWorkHeading(o),d=getEpisodeBody(n,o);r.append(s,d)}}})}function updateEpisode(e,t){for(var i=t.filter(".work-heading").data("annict-id"),r=watchingWorksJson.data.viewer.works.nodes,o=0;o<r.length;o++)if(r[o].annictId==i){r[o].episodes.nodes[0]=e,saveWatchingWorksJson();var n=getEpisodeBody(e,r[o]);t.filter(".episode-body").remove(),t.filter(".work-heading").after(n);break}}function setupEpisodeRecordEvent(e){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),t=e.find(".episode-number").text(),i=e.find(".episode-title").text();if(confirm(t+"\n"+i+"\n\n記録？")){var r=e.filter(".episode-body").data("id");postQuery(function(t){updateEpisode(t.data.createRecord.record.episode,e)},createRecordQuery,getIdVariables(r))}})}function searchEpisode(e,t){var i=e[t];if(i){for(;i[t];)i=i[t];return i}return e.work.episodes.nodes[0]}function setupEpisodeNextPrevEvent(e,t,i,r){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=e.filter(".episode-body").data("annict-id"),n=getIdVariables(o);n.skip=r,postQuery(function(t){updateEpisode(searchEpisode(t.data.searchEpisodes.nodes[0],i),e)},t,n)})}function setupUpdateStatusEvent(e,t,i){e.click(function(){var e=$(this).closest(".work-heading"),r=e.find(".work-link").text();if(confirm(r+i)){var o=e.data("id"),n=getStateVariables(o,t);postQuery(function(t){var i=e.data("annict-id");removeWatchingWorksJson(i);var r=e.closest(".works");if(e.next(".episode-body").remove(),e.remove(),0==r.find(".work-heading").length){var o=r.closest(".group-body");o.prev(".group-heading").remove(),o.remove()}},updateStatusQuery,n)}})}function setupEvent(e){setupUpdateStatusEvent(e.find(".work-watched"),"WATCHED","\n\n見た？"),setupUpdateStatusEvent(e.find(".work-stop"),"STOP_WATCHING","\n\n視聴中止？"),e.find(".work-review").click(function(){var e=$(this).closest(".work-heading"),t=e.find(".work-link").text();if(confirm(t+"\n\n記録？")){var i=e.data("id");postQuery(function(e){alert(e.data.createReview.review.work.title)},createReviewQuery,getIdVariables(i))}}),setupEpisodeRecordEvent(e.find(".episode-record")),setupEpisodeNextPrevEvent(e.find(".episode-skip-prev"),prevEpisodeQuery,"prevEpisode",!0),setupEpisodeNextPrevEvent(e.find(".episode-prev"),prevEpisodeQuery,"prevEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-next"),nextEpisodeQuery,"nextEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-skip-next"),nextEpisodeQuery,"nextEpisode",!0),$("#update").click(function(){updateWatchingWorksJson(function(){renderWatchingWorks()})}),$("#clear").click(function(){clearWatchingWorks(),clearStorage(),loadWatchingWorksJson()})}$(function(){setupEvent($("#group-template")),watchingWorksJson.version!=version?updateWatchingWorksJson(function(){renderWatchingWorks()}):renderWatchingWorks()});