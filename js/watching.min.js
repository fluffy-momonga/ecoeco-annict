function clearWatchingWorks(){$("#watching-works").empty()}function getWorkHeading(e){var t="https://annict.jp/works/"+e.annictId,o=$("#group-template .work-heading").clone(!0,!0);return o.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),o.find(".work-link").attr("href",t).text(e.title),o}function getEpisodeBody(e,t){var o=$("#group-template .episode-body").clone(!0,!0);if(!e)return o.empty();o.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var r="https://annict.jp/works/"+t.annictId+"/episodes/"+e.annictId,i=o.find(".episode-record"),a=(o.find(".episode-link").attr("href",r),o.find(".episode-number").text(e.numberText),o.find(".episode-title").text(e.title?e.title:""));return e.viewerDidTrack?i.prop("disabled",!0):a.hide(),o}var groupList=[{title:"あ",reg:/^[ぁ-お]/,works:[]},{title:"か",reg:/^[か-ご]/,works:[]},{title:"さ",reg:/^[さ-ぞ]/,works:[]},{title:"た",reg:/^[た-ど]/,works:[]},{title:"な",reg:/^[な-の]/,works:[]},{title:"は",reg:/^[は-ぽ]/,works:[]},{title:"ま",reg:/^[ま-も]/,works:[]},{title:"や",reg:/^[ゃ-よ]/,works:[]},{title:"ら",reg:/^[ら-ろ]/,works:[]},{title:"わ",reg:/^[ゎ-ん]/,works:[]},{title:"他",reg:/^./,works:[]}];function renderWatchingWorks(){clearWatchingWorks(),watchingWorksJson.data.viewer.works.nodes.forEach(function(e){for(var t=new TitleNormalizer(e),o=0;o<groupList.length;o++)if(groupList[o].reg.test(t.getKana())){groupList[o].works.push(e);break}});var e=$("#watching-works");groupList.forEach(function(t){if(t.works.length>0){var o=$("#group-template .group-heading, #group-template .group-body").clone(!1,!1),r=o.find(".works");for(o.find(".group-title").text(t.title),r.empty(),e.append(o);t.works.length>0;){var i=t.works.shift(),a=i.episodes.nodes.length>0?i.episodes.nodes[0]:null,n=getWorkHeading(i),d=getEpisodeBody(a,i);r.append(n,d)}}})}function updateEpisode(e,t){for(var o=t.filter(".work-heading").data("annict-id"),r=watchingWorksJson.data.viewer.works.nodes,i=0;i<r.length;i++)if(r[i].annictId==o){r[i].episodes.nodes[0]=e,saveWatchingWorksJson();var a=getEpisodeBody(e,r[i]);t.filter(".episode-body").remove(),t.filter(".work-heading").after(a);break}}function loadChecked(e,t){var o=localStorage.getItem(t);e.prop("checked","true"==o)}function saveChecked(e,t){var o=e.prop("checked");return localStorage.setItem(t,o),o}function setupWorkReviewEvent(e){var t;e.click(function(){var e=$(this).closest(".work-heading"),o=e.find(".work-link").text();t=e.data("id"),$("#review-work-title").text(o),$('[name^="review-rating-"][value=""]').click(),$("#review-body").val(""),loadChecked($("#review-twitter"),"twitter"),loadChecked($("#review-facebook"),"facebook"),$("#review-modal").modal()}),$("#review-modal-ok").click(function(){var e=$('[name="review-rating-overall"]:checked').val(),o=$('[name="review-rating-animation"]:checked').val(),r=$('[name="review-rating-music"]:checked').val(),i=$('[name="review-rating-story"]:checked').val(),a=$('[name="review-rating-character"]:checked').val(),n=$("#review-body").val(),d=saveChecked($("#review-twitter"),"twitter"),s=saveChecked($("#review-facebook"),"facebook");$("#review-modal").modal("hide"),api.createReview(function(e){alertMessage("記録完了","info")},t,n,e,o,r,i,a,d,s)})}function setupEpisodeRecordEvent(e){var t,o;e.click(function(){t=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=t.filter(".episode-body").data("id");var e=t.find(".work-link").text(),r=t.find(".episode-number").text(),i=t.find(".episode-title").text();$("#record-work-title").text(e),$("#record-episode-number").text(r),$("#record-episode-title").text(i),$('[name="record-rating"][value=""]').click(),$("#record-comment").val(""),loadChecked($("#record-twitter"),"twitter"),loadChecked($("#record-facebook"),"facebook"),$("#record-modal").modal()}),$("#record-modal-ok").click(function(){var e=$('[name="record-rating"]:checked').val(),r=$("#record-comment").val(),i=saveChecked($("#record-twitter"),"twitter"),a=saveChecked($("#record-facebook"),"facebook");$("#record-modal").modal("hide"),api.createRecord(function(e){updateEpisode(e.data.createRecord.record.episode,t),alertMessage("記録完了","info")},o,e,r,i,a)})}function searchEpisode(e,t){var o=e[t];if(o){for(;o[t];)o=o[t];return o}return e.work.episodes.nodes[0]}function setupEpisodeNextPrevEvent(e,t,o,r){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),i=e.filter(".episode-body").data("annict-id");t(function(t){updateEpisode(searchEpisode(t.data.searchEpisodes.nodes[0],o),e)},i,r)})}function setupUpdateStatusEvent(e,t,o){var r,i="#"+o;e.click(function(){var e=(r=$(this).closest(".work-heading")).find(".work-link").text();$(i+"-work-title").text(e),$(i+"-modal").modal()}),$(i+"-modal-ok").click(function(){$(i+"-modal").modal("hide");var e=r.data("id");api.updateStatus(function(e){var t=r.data("annict-id");removeWatchingWorksJson(t);var o=r.closest(".works");if(r.next(".episode-body").remove(),r.remove(),0==o.find(".work-heading").length){var i=o.closest(".group-body");i.prev(".group-heading").remove(),i.remove()}alertMessage("変更完了","info")},e,t)})}function setupEvent(e){setupUpdateStatusEvent(e.find(".work-watched"),"WATCHED","watched"),setupUpdateStatusEvent(e.find(".work-stop"),"STOP_WATCHING","stop"),setupWorkReviewEvent(e.find(".work-review")),setupEpisodeRecordEvent(e.find(".episode-record")),setupEpisodeNextPrevEvent(e.find(".episode-skip-prev"),api.prevEpisode,"prevEpisode",!0),setupEpisodeNextPrevEvent(e.find(".episode-prev"),api.prevEpisode,"prevEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-next"),api.nextEpisode,"nextEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-skip-next"),api.nextEpisode,"nextEpisode",!0),$("#update").click(function(){updateWatchingWorksJson(function(){renderWatchingWorks(),alertMessage("更新完了","info")})}),$("#clear").click(function(){clearWatchingWorks(),clearStorage(),loadWatchingWorksJson(),alertMessage("クリア完了","info")})}$(function(){setupEvent($("#group-template")),watchingWorksJson.version!=version?updateWatchingWorksJson(function(){renderWatchingWorks()}):renderWatchingWorks()});