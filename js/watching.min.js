var watchingContent=new function(){var e=new(Object.setPrototypeOf($.extend(function(e){JsonCache.call(this,e)}.prototype,{save:function(){var e=this.get();e.data.viewer.works.nodes.sort(function(e,t){return new TitleNormalizer(e).compare(new TitleNormalizer(t))}),e.episodeAnnictIds=[],e.data.viewer.works.nodes.forEach(function(t){var i=t.episodes.nodes;i.length>0&&e.episodeAnnictIds.push(i[0].annictId)}),JsonCache.prototype.save.call(this)},getDefault:function(){return{data:{viewer:{works:{nodes:[]}}},episodeAnnictIds:[],version:version}}}),JsonCache.prototype).constructor)("watchingWorks"),t=0,i=null,n=function(e){var t=annict.makeWorkPageUrl(e.annictId),n=i.find(".work-heading").clone(!0,!0);return n.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),n.find(".work-link").attr("href",t).text(e.title),n},o=function(e,t){var n=i.find(".episode-body").clone(!0,!0);if(!e)return n.empty();n.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var o=annict.makeEpisodePageUrl(t.annictId,e.annictId),r=n.find(".episode-record"),a=n.find(".episode-title").text(e.title?e.title:"");return n.find(".episode-link").attr("href",o),n.find(".episode-number").text(e.numberText?e.numberText:"--"),e.viewerDidTrack?r.attr("disabled","disabled"):a.hide(),n},r=[{title:"あ",initial:"A",reg:/^[ぁ-お]/,works:[]},{title:"か",initial:"K",reg:/^[か-ご]/,works:[]},{title:"さ",initial:"S",reg:/^[さ-ぞ]/,works:[]},{title:"た",initial:"T",reg:/^[た-ど]/,works:[]},{title:"な",initial:"N",reg:/^[な-の]/,works:[]},{title:"は",initial:"H",reg:/^[は-ぽ]/,works:[]},{title:"ま",initial:"M",reg:/^[ま-も]/,works:[]},{title:"や",initial:"Y",reg:/^[ゃ-よ]/,works:[]},{title:"ら",initial:"R",reg:/^[ら-ろ]/,works:[]},{title:"わ",initial:"W",reg:/^[ゎ-ん]/,works:[]},{title:"他",initial:"O",reg:/^./,works:[]}],a=function(){e.get().data.viewer.works.nodes.forEach(function(e){for(var t=new TitleNormalizer(e),i=0;i<r.length;i++)if(r[i].reg.test(t.getKana())){r[i].works.push(e);break}});var t=$("#watching-works").empty();r.forEach(function(e){var r=e.works.length>0;if(headerContent.toggleInitial(e.initial,r),r){var a=i.find(".group-heading, .group-body").clone(!1,!1),d=a.find(".works");for(a.filter(".group-heading").attr("data-initial",e.initial),a.find(".group-title").text(e.title),d.empty(),t.append(a);e.works.length>0;){var s=e.works.shift(),c=s.episodes.nodes.length>0?s.episodes.nodes[0]:null,l=n(s),f=o(c,s);d.append(l,f)}}})},d=function(t,i){for(var n=i.filter(".work-heading").data("annict-id"),r=e.get().data.viewer.works.nodes,a=0;a<r.length;a++)if(r[a].annictId==n){r[a].episodes.nodes[0]=t,e.save();var d=o(t,r[a]);i.filter(".episode-body").remove(),i.filter(".work-heading").after(d);break}},s=function(t){annict.watchingWorks(function(i){if(i.data.searchEpisodes){var n=i.data.viewer.works.nodes;i.data.searchEpisodes.nodes.forEach(function(e){for(var t=e.work.annictId,i=0;i<n.length;i++)if(n[i].annictId==t){delete e.work,n[i].episodes.nodes=[e];break}}),delete i.data.searchEpisodes}e.set(i),e.save(),t()},e.get().episodeAnnictIds)},c=function(t){!function(t){for(var i=e.get().data.viewer.works.nodes,n=0;n<i.length;n++)if(i[n].id==t)return i.splice(n,1),e.save(),!0}(t);var i=$('#watching-works .work-heading[data-id="'+t+'"]');if(0!=i.length){var n=i.closest(".works");if(i.next(".episode-body").remove(),i.remove(),0==n.find(".work-heading").length){var o=n.closest(".group-body"),r=o.prev(".group-heading"),a=r.data("initial");r.remove(),o.remove(),headerContent.toggleInitial(a,!1)}}},l=function(e,t,i,n){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=e.filter(".episode-body").data("annict-id");t(function(t){var n=t.data.searchEpisodes.nodes;if(n&&0!=n.length){var o=function(e,t){var i=e[t];if(i){for(;i[t];)i=i[t];return i}return e.work.episodes.nodes[0]}(n[0],i);d(o,e)}},o,n)})},f=function(e,t,i){e.click(function(){var e=$(this).closest(".work-heading"),n=e.data("id"),o=e.find(".work-link").text();dialogContent.updateStatusDialog.display(function(e,t){c(e),searchContent.updateWorkStatus(e,t)},t,i,o,n)})},p=function(){f(i.find(".work-watched"),"WATCHED","見た"),f(i.find(".work-hold"),"ON_HOLD","一時中断"),f(i.find(".work-stop"),"STOP_WATCHING","視聴中止"),i.find(".work-review").click(function(){var e=$(this).closest(".work-heading"),t=e.find(".work-link").text(),i=e.data("id");dialogContent.createReviewDialog.display(t,i)}),function(e){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),t=e.find(".work-link").text(),i=e.find(".episode-number").text(),n=e.find(".episode-title").text(),o=e.filter(".episode-body").data("id");dialogContent.createRecordDialog.display(function(t){var i=t.data.createRecord.record.episode;d(i,e)},t,i,n,o)})}(i.find(".episode-record")),l(i.find(".episode-skip-prev"),annict.prevEpisode,"prevEpisode",!0),l(i.find(".episode-prev"),annict.prevEpisode,"prevEpisode",!1),l(i.find(".episode-next"),annict.nextEpisode,"nextEpisode",!1),l(i.find(".episode-skip-next"),annict.nextEpisode,"nextEpisode",!0),$("#update").click(function(){s(function(){a(),headerContent.inform("更新しました。","info")})}),$("#clear").click(function(){StorageCache.clear(),watchingContent.clear(),searchContent.clear(),headerContent.inform("クリアしました。","info")})};this.addWork=function(t){(function(t){for(var i=e.get().data.viewer.works.nodes,n=0;n<i.length;n++)if(i[n].annictId==t.annictId)return!1;return i.push(t),e.save(),!0})(t)&&a()},this.removeWork=c,this.getGroups=function(){return r},this.getGroupTop=function(e){var i=$("#watching-works");return t||(t=i.find(".group-heading:first").offset().top),i.find('.group-heading[data-initial="'+e+'"]').offset().top-t},this.clear=function(){e.remove(),a()},this.build=function(){i=$("#watching-template"),p(),e.get().version!=version?s(function(){a()}):a()}};$(function(){watchingContent.build()});