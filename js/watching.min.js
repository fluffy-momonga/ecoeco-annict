function clearWatchingWorks(){$("#watching-works").empty()}function getWorkHeading(e){var t="https://annict.jp/works/"+e.annictId,r=$("#group-template .work-heading").clone(!0,!0);return r.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),r.find(".work-link").attr("href",t).text(e.title),r}function getEpisodeBody(e,t){var r=$("#group-template .episode-body").clone(!0,!0);if(!e)return r.empty();r.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var o="https://annict.jp/works/"+t.annictId+"/episodes/"+e.annictId,i=r.find(".episode-record"),a=(r.find(".episode-link").attr("href",o),r.find(".episode-number").text(e.numberText),r.find(".episode-title").text(e.title?e.title:""));return e.viewerDidTrack?i.prop("disabled",!0):a.hide(),r}var groupList=[{title:"あ",reg:/^[ぁ-お]/,works:[]},{title:"か",reg:/^[か-ご]/,works:[]},{title:"さ",reg:/^[さ-ぞ]/,works:[]},{title:"た",reg:/^[た-ど]/,works:[]},{title:"な",reg:/^[な-の]/,works:[]},{title:"は",reg:/^[は-ぽゔ]/,works:[]},{title:"ま",reg:/^[ま-も]/,works:[]},{title:"や",reg:/^[ゃ-よ]/,works:[]},{title:"ら",reg:/^[ら-ろ]/,works:[]},{title:"わ",reg:/^[ゎ-ん]/,works:[]},{title:"他",reg:/^./,works:[]}];function renderWatchingWorks(){clearWatchingWorks(),watchingWorksJson.data.viewer.works.nodes.forEach(function(e){for(var t=0;t<groupList.length;t++){var r=groupList[t].reg;if(r.test(e.titleKana)||r.test(e.title)){groupList[t].works.push(e);break}}});var e=$("#watching-works");groupList.forEach(function(t){if(t.works.length>0){var r=$("#group-template .group-heading, #group-template .group-body").clone(!1,!1),o=r.find(".works");for(r.find(".group-title").text(t.title),o.empty(),e.append(r);t.works.length>0;){var i=t.works.shift(),a=i.episodes.nodes.length>0?i.episodes.nodes[0]:null,n=getWorkHeading(i),d=getEpisodeBody(a,i);o.append(n,d)}}})}function updateEpisode(e,t){for(var r=t.filter(".work-heading").data("annict-id"),o=watchingWorksJson.data.viewer.works.nodes,i=0;i<o.length;i++)if(o[i].annictId==r){o[i].episodes.nodes[0]=e,saveWatchingWorksJson();var a=getEpisodeBody(e,o[i]);t.filter(".episode-body").remove(),t.filter(".work-heading").after(a);break}}function loadChecked(e,t){var r=localStorage.getItem(t);e.prop("checked","true"==r)}function saveChecked(e,t){var r=e.prop("checked");return localStorage.setItem(t,r),r}function setupWorkReviewEvent(e){var t;e.click(function(){var e=$(this).closest(".work-heading"),r=e.find(".work-link").text();t=e.data("id"),$("#review-work-title").text(r),$('[name^="review-rating-"][value=""]').click(),$("#review-body").val(""),loadChecked($("#review-twitter"),"twitter"),loadChecked($("#review-facebook"),"facebook"),$("#review-modal").modal()}),$("#review-modal-ok").click(function(){var e=$('[name="review-rating-overall"]:checked').val(),r=$('[name="review-rating-animation"]:checked').val(),o=$('[name="review-rating-music"]:checked').val(),i=$('[name="review-rating-story"]:checked').val(),a=$('[name="review-rating-character"]:checked').val(),n=$("#review-body").val(),d=saveChecked($("#review-twitter"),"twitter"),s=saveChecked($("#review-facebook"),"facebook");$("#review-modal").modal("hide"),postQuery(function(e){alertMessage("記録完了","info")},createReviewQuery,getWorkReviewVariables(t,n,e,r,o,i,a,d,s))})}function setupEpisodeRecordEvent(e){var t,r;e.click(function(){t=$(this).closest(".episode-body").prev(".work-heading").andSelf(),r=t.filter(".episode-body").data("id");var e=t.find(".work-link").text(),o=t.find(".episode-number").text(),i=t.find(".episode-title").text();$("#record-work-title").text(e),$("#record-episode-number").text(o),$("#record-episode-title").text(i),$('[name="record-rating"][value=""]').click(),$("#record-comment").val(""),loadChecked($("#record-twitter"),"twitter"),loadChecked($("#record-facebook"),"facebook"),$("#record-modal").modal()}),$("#record-modal-ok").click(function(){var e=$('[name="record-rating"]:checked').val(),o=$("#record-comment").val(),i=saveChecked($("#record-twitter"),"twitter"),a=saveChecked($("#record-facebook"),"facebook");$("#record-modal").modal("hide"),postQuery(function(e){updateEpisode(e.data.createRecord.record.episode,t),alertMessage("記録完了","info")},createRecordQuery,getEpisodeRecordVariables(r,e,o,i,a))})}function searchEpisode(e,t){var r=e[t];if(r){for(;r[t];)r=r[t];return r}return e.work.episodes.nodes[0]}function setupEpisodeNextPrevEvent(e,t,r,o){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),i=e.filter(".episode-body").data("annict-id"),a=getIdVariables(i);a.skip=o,postQuery(function(t){updateEpisode(searchEpisode(t.data.searchEpisodes.nodes[0],r),e)},t,a)})}function setupUpdateStatusEvent(e,t,r){var o,i="#"+r;e.click(function(){var e=(o=$(this).closest(".work-heading")).find(".work-link").text();$(i+"-work-title").text(e),$(i+"-modal").modal()}),$(i+"-modal-ok").click(function(){$(i+"-modal").modal("hide");var e=o.data("id"),r=getStateVariables(e,t);postQuery(function(e){var t=o.data("annict-id");removeWatchingWorksJson(t);var r=o.closest(".works");if(o.next(".episode-body").remove(),o.remove(),0==r.find(".work-heading").length){var i=r.closest(".group-body");i.prev(".group-heading").remove(),i.remove()}alertMessage("変更完了","info")},updateStatusQuery,r)})}function setupEvent(e){setupUpdateStatusEvent(e.find(".work-watched"),"WATCHED","watched"),setupUpdateStatusEvent(e.find(".work-stop"),"STOP_WATCHING","stop"),setupWorkReviewEvent(e.find(".work-review")),setupEpisodeRecordEvent(e.find(".episode-record")),setupEpisodeNextPrevEvent(e.find(".episode-skip-prev"),prevEpisodeQuery,"prevEpisode",!0),setupEpisodeNextPrevEvent(e.find(".episode-prev"),prevEpisodeQuery,"prevEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-next"),nextEpisodeQuery,"nextEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-skip-next"),nextEpisodeQuery,"nextEpisode",!0),$("#update").click(function(){updateWatchingWorksJson(function(){renderWatchingWorks(),alertMessage("更新完了","info")})}),$("#clear").click(function(){clearWatchingWorks(),clearStorage(),loadWatchingWorksJson(),alertMessage("クリア完了","info")})}$(function(){setupEvent($("#group-template")),watchingWorksJson.version!=version?updateWatchingWorksJson(function(){renderWatchingWorks()}):renderWatchingWorks()});