var watchingContent=new function(){var e=new(Object.setPrototypeOf($.extend(function(e){JsonCache.call(this,e)}.prototype,{save:function(){var e=this.get();e.data.viewer.works.nodes.sort(function(e,t){return new TitleNormalizer(e).compare(new TitleNormalizer(t))}),e.episodeAnnictIds=[],e.data.viewer.works.nodes.forEach(function(t){var r=t.episodes.nodes;r.length>0&&e.episodeAnnictIds.push(r[0].annictId)}),JsonCache.prototype.save.call(this)},getDefault:function(){return{data:{viewer:{works:{nodes:[]}}},episodeAnnictIds:[],version:version}}}),JsonCache.prototype).constructor)("watchingWorks"),t=new StorageCache("twitter"),r=new StorageCache("facebook"),i=function(e){var t="https://annict.jp/works/"+e.annictId,r=$("#group-template .work-heading").clone(!0,!0);return r.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),r.find(".work-link").attr("href",t).text(e.title),r},o=function(e,t){var r=$("#group-template .episode-body").clone(!0,!0);if(!e)return r.empty();r.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var i="https://annict.jp/works/"+t.annictId+"/episodes/"+e.annictId,o=r.find(".episode-record"),n=(r.find(".episode-link").attr("href",i),r.find(".episode-number").text(e.numberText),r.find(".episode-title").text(e.title?e.title:""));return e.viewerDidTrack?o.attr("disabled","disabled"):n.hide(),r},n=[{title:"あ",reg:/^[ぁ-お]/,works:[]},{title:"か",reg:/^[か-ご]/,works:[]},{title:"さ",reg:/^[さ-ぞ]/,works:[]},{title:"た",reg:/^[た-ど]/,works:[]},{title:"な",reg:/^[な-の]/,works:[]},{title:"は",reg:/^[は-ぽ]/,works:[]},{title:"ま",reg:/^[ま-も]/,works:[]},{title:"や",reg:/^[ゃ-よ]/,works:[]},{title:"ら",reg:/^[ら-ろ]/,works:[]},{title:"わ",reg:/^[ゎ-ん]/,works:[]},{title:"他",reg:/^./,works:[]}],a=function(){e.get().data.viewer.works.nodes.forEach(function(e){for(var t=new TitleNormalizer(e),r=0;r<n.length;r++)if(n[r].reg.test(t.getKana())){n[r].works.push(e);break}});var t=$("#watching-works").empty();n.forEach(function(e){if(e.works.length>0){var r=$("#group-template .group-heading, #group-template .group-body").clone(!1,!1),n=r.find(".works");for(r.find(".group-title").text(e.title),n.empty(),t.append(r);e.works.length>0;){var a=e.works.shift(),d=a.episodes.nodes.length>0?a.episodes.nodes[0]:null,c=i(a),s=o(d,a);n.append(c,s)}}})},d=function(t,r){for(var i=r.filter(".work-heading").data("annict-id"),n=e.get().data.viewer.works.nodes,a=0;a<n.length;a++)if(n[a].annictId==i){n[a].episodes.nodes[0]=t,e.save();var d=o(t,n[a]);r.filter(".episode-body").remove(),r.filter(".work-heading").after(d);break}},c=function(t){api.watchingWorks(function(r){if(r.data.searchEpisodes){var i=r.data.viewer.works.nodes;r.data.searchEpisodes.nodes.forEach(function(e){for(var t=e.work.annictId,r=0;r<i.length;r++)if(i[r].annictId==t){delete e.work,i[r].episodes.nodes=[e];break}}),delete r.data.searchEpisodes}e.set(r),e.save(),t()},e.get().episodeAnnictIds)},s=function(t){for(var r=e.get().data.viewer.works.nodes,i=0;i<r.length;i++)if(r[i].annictId==t)return r.splice(i,1),e.save(),!0;return!1},l=function(e,t){var r=t.get();e.prop("checked","true"==r)},f=function(e,t){var r=e.prop("checked");return t.set(r),r},p=function(e,t,r,i){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=e.filter(".episode-body").data("annict-id");t(function(t){var i=function(e,t){var r=e[t];if(r){for(;r[t];)r=r[t];return r}return e.work.episodes.nodes[0]}(t.data.searchEpisodes.nodes[0],r);d(i,e)},o,i)})},v=function(e,t,r){var i,o="#"+r;e.click(function(){var e=(i=$(this).closest(".work-heading")).find(".work-link").text();$(o+"-work-title").text(e),$(o+"-modal").modal()}),$(o+"-modal-ok").click(function(){$(o+"-modal").modal("hide");var e=i.data("id");api.updateStatus(function(e){var t=i.data("annict-id");s(t);var r=i.closest(".works");if(i.next(".episode-body").remove(),i.remove(),0==r.find(".work-heading").length){var o=r.closest(".group-body");o.prev(".group-heading").remove(),o.remove()}alertMessage("変更しました。","info")},e,t)})},w=function(e){var i;v(e.find(".work-watched"),"WATCHED","watched"),v(e.find(".work-stop"),"STOP_WATCHING","stop"),e.find(".work-review").click(function(){var e=$(this).closest(".work-heading"),o=e.find(".work-link").text();i=e.data("id"),$("#review-work-title").text(o),$('[name^="review-rating-"][value=""]').click(),$("#review-body").val(""),l($("#review-twitter"),t),l($("#review-facebook"),r),$("#review-modal").modal()}),$("#review-modal-ok").click(function(){var e=$('[name="review-rating-overall"]:checked').val(),o=$('[name="review-rating-animation"]:checked').val(),n=$('[name="review-rating-music"]:checked').val(),a=$('[name="review-rating-story"]:checked').val(),d=$('[name="review-rating-character"]:checked').val(),c=$("#review-body").val(),s=f($("#review-twitter"),t),l=f($("#review-facebook"),r);$("#review-modal").modal("hide"),api.createReview(function(e){alertMessage("記録しました。","info")},i,c,e,o,n,a,d,s,l)}),function(e){var i,o;e.click(function(){i=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=i.filter(".episode-body").data("id");var e=i.find(".work-link").text(),n=i.find(".episode-number").text(),a=i.find(".episode-title").text();$("#record-work-title").text(e),$("#record-episode-number").text(n),$("#record-episode-title").text(a),$('[name="record-rating"][value=""]').click(),$("#record-comment").val(""),l($("#record-twitter"),t),l($("#record-facebook"),r),$("#record-modal").modal()}),$("#record-modal-ok").click(function(){var e=$('[name="record-rating"]:checked').val(),n=$("#record-comment").val(),a=f($("#record-twitter"),t),c=f($("#record-facebook"),r);$("#record-modal").modal("hide"),api.createRecord(function(e){var t=e.data.createRecord.record.episode;d(t,i),alertMessage("記録しました。","info")},o,e,n,a,c)})}(e.find(".episode-record")),p(e.find(".episode-skip-prev"),api.prevEpisode,"prevEpisode",!0),p(e.find(".episode-prev"),api.prevEpisode,"prevEpisode",!1),p(e.find(".episode-next"),api.nextEpisode,"nextEpisode",!1),p(e.find(".episode-skip-next"),api.nextEpisode,"nextEpisode",!0),$("#update").click(function(){c(function(){a(),alertMessage("更新しました。","info")})}),$("#clear").click(function(){StorageCache.clear(),watchingContent.clear(),searchContent.clear(),alertMessage("クリアしました。","info")})};this.clear=function(){e.remove(),a()},this.build=function(){w($("#group-template")),e.get().version!=version?c(function(){a()}):a()},this.addWork=function(t){(function(t){for(var r=e.get().data.viewer.works.nodes,i=0;i<r.length;i++)if(r[i].annictId==t.annictId)return!1;return r.push(t),e.save(),!0})(t)&&a()},this.removeWork=function(e){s(e)&&a()}};$(function(){watchingContent.build()});