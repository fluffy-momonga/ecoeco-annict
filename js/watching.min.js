var watchingContent=new function(){var e=new(Object.setPrototypeOf($.extend(function(e){JsonCache.call(this,e)}.prototype,{save:function(){var e=this.get();e.data.viewer.works.nodes.sort(function(e,t){return new TitleNormalizer(e).compare(new TitleNormalizer(t))}),e.episodeAnnictIds=[],e.data.viewer.works.nodes.forEach(function(t){var i=t.episodes.nodes;i.length>0&&e.episodeAnnictIds.push(i[0].annictId)}),JsonCache.prototype.save.call(this)},getDefault:function(){return{data:{viewer:{works:{nodes:[]}}},episodeAnnictIds:[],version:version}}}),JsonCache.prototype).constructor)("watchingWorks"),t=new StorageCache("twitter"),i=new StorageCache("facebook"),r=function(e){var t="https://annict.jp/works/"+e.annictId,i=$("#group-template .work-heading").clone(!0,!0);return i.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),i.find(".work-link").attr("href",t).text(e.title),i},o=function(e,t){var i=$("#group-template .episode-body").clone(!0,!0);if(!e)return i.empty();i.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var r="https://annict.jp/works/"+t.annictId+"/episodes/"+e.annictId,o=i.find(".episode-record"),n=(i.find(".episode-link").attr("href",r),i.find(".episode-number").text(e.numberText),i.find(".episode-title").text(e.title?e.title:""));return e.viewerDidTrack?o.attr("disabled","disabled"):n.hide(),i},n=[{title:"あ",reg:/^[ぁ-お]/,works:[]},{title:"か",reg:/^[か-ご]/,works:[]},{title:"さ",reg:/^[さ-ぞ]/,works:[]},{title:"た",reg:/^[た-ど]/,works:[]},{title:"な",reg:/^[な-の]/,works:[]},{title:"は",reg:/^[は-ぽ]/,works:[]},{title:"ま",reg:/^[ま-も]/,works:[]},{title:"や",reg:/^[ゃ-よ]/,works:[]},{title:"ら",reg:/^[ら-ろ]/,works:[]},{title:"わ",reg:/^[ゎ-ん]/,works:[]},{title:"他",reg:/^./,works:[]}],a=function(){e.get().data.viewer.works.nodes.forEach(function(e){for(var t=new TitleNormalizer(e),i=0;i<n.length;i++)if(n[i].reg.test(t.getKana())){n[i].works.push(e);break}});var t=$("#watching-works").empty();n.forEach(function(e){if(e.works.length>0){var i=$("#group-template .group-heading, #group-template .group-body").clone(!1,!1),n=i.find(".works");for(i.find(".group-title").text(e.title),n.empty(),t.append(i);e.works.length>0;){var a=e.works.shift(),d=a.episodes.nodes.length>0?a.episodes.nodes[0]:null,s=r(a),c=o(d,a);n.append(s,c)}}})},d=function(t,i){for(var r=i.filter(".work-heading").data("annict-id"),n=e.get().data.viewer.works.nodes,a=0;a<n.length;a++)if(n[a].annictId==r){n[a].episodes.nodes[0]=t,e.save();var d=o(t,n[a]);i.filter(".episode-body").remove(),i.filter(".work-heading").after(d);break}},s=function(t){api.watchingWorks(function(i){if(i.data.searchEpisodes){var r=i.data.viewer.works.nodes;i.data.searchEpisodes.nodes.forEach(function(e){for(var t=e.work.annictId,i=0;i<r.length;i++)if(r[i].annictId==t){delete e.work,r[i].episodes.nodes=[e];break}}),delete i.data.searchEpisodes}e.set(i),e.save(),t()},e.get().episodeAnnictIds)},c=function(t){for(var i=e.get().data.viewer.works.nodes,r=0;r<i.length;r++)if(i[r].annictId==t)return i.splice(r,1),e.save(),!0;return!1},l=function(e,t){var i=t.get();e.prop("checked","true"==i)},p=function(e,t){var i=e.prop("checked");return t.set(i),i},f=function(e,t,i,r){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=e.filter(".episode-body").data("annict-id");t(function(t){var r=function(e,t){var i=e[t];if(i){for(;i[t];)i=i[t];return i}return e.work.episodes.nodes[0]}(t.data.searchEpisodes.nodes[0],i);d(r,e)},o,r)})},v=function(e,t,i){var r,o="#"+i;e.click(function(){var e=(r=$(this).closest(".work-heading")).find(".work-link").text();$(o+"-work-title").text(e),$(o+"-modal").modal()}),$(o+"-modal-ok").click(function(){$(o+"-modal").modal("hide");var e=r.data("id");api.updateStatus(function(e){var t=r.data("annict-id");c(t);var i=r.closest(".works");if(r.next(".episode-body").remove(),r.remove(),0==i.find(".work-heading").length){var o=i.closest(".group-body");o.prev(".group-heading").remove(),o.remove()}alertMessage("変更完了","info")},e,t)})},w=function(r){var o;v(r.find(".work-watched"),"WATCHED","watched"),v(r.find(".work-stop"),"STOP_WATCHING","stop"),r.find(".work-review").click(function(){var e=$(this).closest(".work-heading"),r=e.find(".work-link").text();o=e.data("id"),$("#review-work-title").text(r),$('[name^="review-rating-"][value=""]').click(),$("#review-body").val(""),l($("#review-twitter"),t),l($("#review-facebook"),i),$("#review-modal").modal()}),$("#review-modal-ok").click(function(){var e=$('[name="review-rating-overall"]:checked').val(),r=$('[name="review-rating-animation"]:checked').val(),n=$('[name="review-rating-music"]:checked').val(),a=$('[name="review-rating-story"]:checked').val(),d=$('[name="review-rating-character"]:checked').val(),s=$("#review-body").val(),c=p($("#review-twitter"),t),l=p($("#review-facebook"),i);$("#review-modal").modal("hide"),api.createReview(function(e){alertMessage("記録完了","info")},o,s,e,r,n,a,d,c,l)}),function(e){var r,o;e.click(function(){r=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=r.filter(".episode-body").data("id");var e=r.find(".work-link").text(),n=r.find(".episode-number").text(),a=r.find(".episode-title").text();$("#record-work-title").text(e),$("#record-episode-number").text(n),$("#record-episode-title").text(a),$('[name="record-rating"][value=""]').click(),$("#record-comment").val(""),l($("#record-twitter"),t),l($("#record-facebook"),i),$("#record-modal").modal()}),$("#record-modal-ok").click(function(){var e=$('[name="record-rating"]:checked').val(),n=$("#record-comment").val(),a=p($("#record-twitter"),t),s=p($("#record-facebook"),i);$("#record-modal").modal("hide"),api.createRecord(function(e){var t=e.data.createRecord.record.episode;d(t,r),alertMessage("記録完了","info")},o,e,n,a,s)})}(r.find(".episode-record")),f(r.find(".episode-skip-prev"),api.prevEpisode,"prevEpisode",!0),f(r.find(".episode-prev"),api.prevEpisode,"prevEpisode",!1),f(r.find(".episode-next"),api.nextEpisode,"nextEpisode",!1),f(r.find(".episode-skip-next"),api.nextEpisode,"nextEpisode",!0),$("#update").click(function(){s(function(){a(),alertMessage("更新完了","info")})}),$("#clear").click(function(){StorageCache.clear(),e.remove(),a(),searchContent.clear(),alertMessage("クリア完了","info")})};this.initialize=function(){w($("#group-template")),e.get().version!=version?s(function(){a()}):a()},this.addWatchingWorksJson=function(t){(function(t){for(var i=e.get().data.viewer.works.nodes,r=0;r<i.length;r++)if(i[r].annictId==t.annictId)return!1;return i.push(t),e.save(),!0})(t)&&a()},this.removeWatchingWorksJson=function(e){c(e)&&a()}};$(function(){watchingContent.initialize()});