function clearWatchingWorks(){$("#watching-works").empty()}function getWorkHeading(e){var t="https://annict.jp/works/"+e.annictId,r=$("#group-template .work-heading").clone(!0,!0);return r.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),r.find(".work-link").attr("href",t).text(e.title),r}function getEpisodeBody(e,t){var r=$("#group-template .episode-body").clone(!0,!0);if(!e)return r.empty();r.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var i="https://annict.jp/works/"+t.annictId+"/episodes/"+e.annictId,o=r.find(".episode-record"),n=(r.find(".episode-link").attr("href",i),r.find(".episode-number").text(e.numberText),r.find(".episode-title").text(e.title?e.title:""));return e.viewerDidTrack?o.prop("disabled",!0):n.hide(),r}var groupList=[{title:"あ",reg:/^[ぁ-お]/,works:[]},{title:"か",reg:/^[か-ご]/,works:[]},{title:"さ",reg:/^[さ-ぞ]/,works:[]},{title:"た",reg:/^[た-ど]/,works:[]},{title:"な",reg:/^[な-の]/,works:[]},{title:"は",reg:/^[は-ぽゔ]/,works:[]},{title:"ま",reg:/^[ま-も]/,works:[]},{title:"や",reg:/^[ゃ-よ]/,works:[]},{title:"ら",reg:/^[ら-ろ]/,works:[]},{title:"わ",reg:/^[ゎ-ん]/,works:[]},{title:"他",reg:/^./,works:[]}];function renderWatchingWorks(){clearWatchingWorks(),watchingWorksJson.data.viewer.works.nodes.forEach(function(e){for(var t=0;t<groupList.length;t++)if(groupList[t].reg.test(e.titleKana)){groupList[t].works.push(e);break}});var e=$("#watching-works");groupList.forEach(function(t){if(t.works.length>0){var r=$("#group-template .group-heading, #group-template .group-body").clone(!1,!1),i=r.find(".works");for(r.find(".group-title").text(t.title),i.empty(),e.append(r);t.works.length>0;){var o=t.works.shift(),n=o.episodes.nodes.length>0?o.episodes.nodes[0]:null,a=getWorkHeading(o),d=getEpisodeBody(n,o);i.append(a,d)}}})}function updateEpisode(e,t){for(var r=t.filter(".work-heading").data("annict-id"),i=watchingWorksJson.data.viewer.works.nodes,o=0;o<i.length;o++)if(i[o].annictId==r){i[o].episodes.nodes[0]=e,saveWatchingWorksJson();var n=getEpisodeBody(e,i[o]);t.filter(".episode-body").remove(),t.filter(".work-heading").after(n);break}}function setupWorkReviewEvent(e){var t;e.click(function(){var e=$(this).closest(".work-heading"),r=e.find(".work-link").text();t=e.data("id"),$("#review-work-title").text(r),$('[name^="review-rating-"][value=""]').click(),$("#review-body").val(""),$("#review-modal").modal()}),$("#review-modal-ok").click(function(){var e=$('[name="review-rating-overall"]:checked').val(),r=$('[name="review-rating-animation"]:checked').val(),i=$('[name="review-rating-music"]:checked').val(),o=$('[name="review-rating-story"]:checked').val(),n=$('[name="review-rating-character"]:checked').val(),a=$("#review-body").val();$("#review-modal").modal("hide"),postQuery(function(e){alertMessage("記録完了","info")},createReviewQuery,getWorkReviewVariables(t,a,e,r,i,o,n))})}function setupEpisodeRecordEvent(e){var t,r;e.click(function(){t=$(this).closest(".episode-body").prev(".work-heading").andSelf(),r=t.filter(".episode-body").data("id");var e=t.find(".work-link").text(),i=t.find(".episode-number").text(),o=t.find(".episode-title").text();$("#record-work-title").text(e),$("#record-episode-number").text(i),$("#record-episode-title").text(o),$('[name="record-rating"][value=""]').click(),$("#record-comment").val(""),$("#record-modal").modal()}),$("#record-modal-ok").click(function(){var e=$('[name="record-rating"]:checked').val(),i=$("#record-comment").val();$("#record-modal").modal("hide"),postQuery(function(e){updateEpisode(e.data.createRecord.record.episode,t),alertMessage("記録完了","info")},createRecordQuery,getEpisodeRecordVariables(r,e,i))})}function searchEpisode(e,t){var r=e[t];if(r){for(;r[t];)r=r[t];return r}return e.work.episodes.nodes[0]}function setupEpisodeNextPrevEvent(e,t,r,i){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=e.filter(".episode-body").data("annict-id"),n=getIdVariables(o);n.skip=i,postQuery(function(t){updateEpisode(searchEpisode(t.data.searchEpisodes.nodes[0],r),e)},t,n)})}function setupUpdateStatusEvent(e,t,r){var i,o="#"+r;e.click(function(){var e=(i=$(this).closest(".work-heading")).find(".work-link").text();$(o+"-work-title").text(e),$(o+"-modal").modal()}),$(o+"-modal-ok").click(function(){$(o+"-modal").modal("hide");var e=i.data("id"),r=getStateVariables(e,t);postQuery(function(e){var t=i.data("annict-id");removeWatchingWorksJson(t);var r=i.closest(".works");if(i.next(".episode-body").remove(),i.remove(),0==r.find(".work-heading").length){var o=r.closest(".group-body");o.prev(".group-heading").remove(),o.remove()}alertMessage("変更完了","info")},updateStatusQuery,r)})}function setupEvent(e){setupUpdateStatusEvent(e.find(".work-watched"),"WATCHED","watched"),setupUpdateStatusEvent(e.find(".work-stop"),"STOP_WATCHING","stop"),setupWorkReviewEvent(e.find(".work-review")),setupEpisodeRecordEvent(e.find(".episode-record")),setupEpisodeNextPrevEvent(e.find(".episode-skip-prev"),prevEpisodeQuery,"prevEpisode",!0),setupEpisodeNextPrevEvent(e.find(".episode-prev"),prevEpisodeQuery,"prevEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-next"),nextEpisodeQuery,"nextEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-skip-next"),nextEpisodeQuery,"nextEpisode",!0),$("#update").click(function(){updateWatchingWorksJson(function(){renderWatchingWorks(),alertMessage("更新完了","info")})}),$("#clear").click(function(){clearWatchingWorks(),clearStorage(),loadWatchingWorksJson(),alertMessage("クリア完了","info")})}$(function(){setupEvent($("#group-template")),watchingWorksJson.version!=version?updateWatchingWorksJson(function(){renderWatchingWorks()}):renderWatchingWorks()});