var watchingWorksJsonCache=new(Object.setPrototypeOf($.extend(function(e){JsonCache.call(this,e)}.prototype,{save:function(){var e=this.item;e.data.viewer.works.nodes.sort(function(e,t){return new TitleNormalizer(e).compare(new TitleNormalizer(t))}),e.episodeAnnictIds=[],e.data.viewer.works.nodes.forEach(function(t){var o=t.episodes.nodes;o.length>0&&e.episodeAnnictIds.push(o[0].annictId)}),JsonCache.prototype.save.call(this)},getDefault:function(){return{data:{viewer:{works:{nodes:[]}}},episodeAnnictIds:[],version:version}}}),JsonCache.prototype).constructor)("watchingWorks");function updateWatchingWorksJson(e){api.watchingWorks(function(t){if(t.data.searchEpisodes){var o=t.data.viewer.works.nodes;t.data.searchEpisodes.nodes.forEach(function(e){for(var t=e.work.annictId,r=0;r<o.length;r++)if(o[r].annictId==t){delete e.work,o[r].episodes.nodes=[e];break}}),delete t.data.searchEpisodes}watchingWorksJsonCache.set(t),watchingWorksJsonCache.save(),e()},watchingWorksJsonCache.get().episodeAnnictIds)}function addWatchingWorksJson(e){for(var t=watchingWorksJsonCache.get().data.viewer.works.nodes,o=0;o<t.length;o++)if(t[o].annictId==e.annictId)return!1;return t.push(e),watchingWorksJsonCache.save(),!0}function removeWatchingWorksJson(e){for(var t=watchingWorksJsonCache.get().data.viewer.works.nodes,o=0;o<t.length;o++)if(t[o].annictId==e)return t.splice(o,1),watchingWorksJsonCache.save(),!0;return!1}function getWorkHeading(e){var t="https://annict.jp/works/"+e.annictId,o=$("#group-template .work-heading").clone(!0,!0);return o.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId),o.find(".work-link").attr("href",t).text(e.title),o}function getEpisodeBody(e,t){var o=$("#group-template .episode-body").clone(!0,!0);if(!e)return o.empty();o.removeData().attr("data-id",e.id).attr("data-annict-id",e.annictId);var r="https://annict.jp/works/"+t.annictId+"/episodes/"+e.annictId,i=o.find(".episode-record"),n=(o.find(".episode-link").attr("href",r),o.find(".episode-number").text(e.numberText),o.find(".episode-title").text(e.title?e.title:""));return e.viewerDidTrack?i.attr("disabled","disabled"):n.hide(),o}var groupList=[{title:"あ",reg:/^[ぁ-お]/,works:[]},{title:"か",reg:/^[か-ご]/,works:[]},{title:"さ",reg:/^[さ-ぞ]/,works:[]},{title:"た",reg:/^[た-ど]/,works:[]},{title:"な",reg:/^[な-の]/,works:[]},{title:"は",reg:/^[は-ぽ]/,works:[]},{title:"ま",reg:/^[ま-も]/,works:[]},{title:"や",reg:/^[ゃ-よ]/,works:[]},{title:"ら",reg:/^[ら-ろ]/,works:[]},{title:"わ",reg:/^[ゎ-ん]/,works:[]},{title:"他",reg:/^./,works:[]}];function renderWatchingWorks(){watchingWorksJsonCache.get().data.viewer.works.nodes.forEach(function(e){for(var t=new TitleNormalizer(e),o=0;o<groupList.length;o++)if(groupList[o].reg.test(t.getKana())){groupList[o].works.push(e);break}});var e=$("#watching-works").empty();groupList.forEach(function(t){if(t.works.length>0){var o=$("#group-template .group-heading, #group-template .group-body").clone(!1,!1),r=o.find(".works");for(o.find(".group-title").text(t.title),r.empty(),e.append(o);t.works.length>0;){var i=t.works.shift(),n=i.episodes.nodes.length>0?i.episodes.nodes[0]:null,a=getWorkHeading(i),d=getEpisodeBody(n,i);r.append(a,d)}}})}function updateEpisode(e,t){for(var o=t.filter(".work-heading").data("annict-id"),r=watchingWorksJsonCache.get().data.viewer.works.nodes,i=0;i<r.length;i++)if(r[i].annictId==o){r[i].episodes.nodes[0]=e,watchingWorksJsonCache.save();var n=getEpisodeBody(e,r[i]);t.filter(".episode-body").remove(),t.filter(".work-heading").after(n);break}}function loadChecked(e,t){var o=localStorage.getItem(t);e.prop("checked","true"==o)}function saveChecked(e,t){var o=e.prop("checked");return localStorage.setItem(t,o),o}function setupWorkReviewEvent(e){var t;e.click(function(){var e=$(this).closest(".work-heading"),o=e.find(".work-link").text();t=e.data("id"),$("#review-work-title").text(o),$('[name^="review-rating-"][value=""]').click(),$("#review-body").val(""),loadChecked($("#review-twitter"),"twitter"),loadChecked($("#review-facebook"),"facebook"),$("#review-modal").modal()}),$("#review-modal-ok").click(function(){var e=$('[name="review-rating-overall"]:checked').val(),o=$('[name="review-rating-animation"]:checked').val(),r=$('[name="review-rating-music"]:checked').val(),i=$('[name="review-rating-story"]:checked').val(),n=$('[name="review-rating-character"]:checked').val(),a=$("#review-body").val(),d=saveChecked($("#review-twitter"),"twitter"),s=saveChecked($("#review-facebook"),"facebook");$("#review-modal").modal("hide"),api.createReview(function(e){alertMessage("記録完了","info")},t,a,e,o,r,i,n,d,s)})}function setupEpisodeRecordEvent(e){var t,o;e.click(function(){t=$(this).closest(".episode-body").prev(".work-heading").andSelf(),o=t.filter(".episode-body").data("id");var e=t.find(".work-link").text(),r=t.find(".episode-number").text(),i=t.find(".episode-title").text();$("#record-work-title").text(e),$("#record-episode-number").text(r),$("#record-episode-title").text(i),$('[name="record-rating"][value=""]').click(),$("#record-comment").val(""),loadChecked($("#record-twitter"),"twitter"),loadChecked($("#record-facebook"),"facebook"),$("#record-modal").modal()}),$("#record-modal-ok").click(function(){var e=$('[name="record-rating"]:checked').val(),r=$("#record-comment").val(),i=saveChecked($("#record-twitter"),"twitter"),n=saveChecked($("#record-facebook"),"facebook");$("#record-modal").modal("hide"),api.createRecord(function(e){updateEpisode(e.data.createRecord.record.episode,t),alertMessage("記録完了","info")},o,e,r,i,n)})}function searchEpisode(e,t){var o=e[t];if(o){for(;o[t];)o=o[t];return o}return e.work.episodes.nodes[0]}function setupEpisodeNextPrevEvent(e,t,o,r){e.click(function(){var e=$(this).closest(".episode-body").prev(".work-heading").andSelf(),i=e.filter(".episode-body").data("annict-id");t(function(t){updateEpisode(searchEpisode(t.data.searchEpisodes.nodes[0],o),e)},i,r)})}function setupUpdateStatusEvent(e,t,o){var r,i="#"+o;e.click(function(){var e=(r=$(this).closest(".work-heading")).find(".work-link").text();$(i+"-work-title").text(e),$(i+"-modal").modal()}),$(i+"-modal-ok").click(function(){$(i+"-modal").modal("hide");var e=r.data("id");api.updateStatus(function(e){removeWatchingWorksJson(r.data("annict-id"));var t=r.closest(".works");if(r.next(".episode-body").remove(),r.remove(),0==t.find(".work-heading").length){var o=t.closest(".group-body");o.prev(".group-heading").remove(),o.remove()}alertMessage("変更完了","info")},e,t)})}function setupEvent(e){setupUpdateStatusEvent(e.find(".work-watched"),"WATCHED","watched"),setupUpdateStatusEvent(e.find(".work-stop"),"STOP_WATCHING","stop"),setupWorkReviewEvent(e.find(".work-review")),setupEpisodeRecordEvent(e.find(".episode-record")),setupEpisodeNextPrevEvent(e.find(".episode-skip-prev"),api.prevEpisode,"prevEpisode",!0),setupEpisodeNextPrevEvent(e.find(".episode-prev"),api.prevEpisode,"prevEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-next"),api.nextEpisode,"nextEpisode",!1),setupEpisodeNextPrevEvent(e.find(".episode-skip-next"),api.nextEpisode,"nextEpisode",!0),$("#update").click(function(){updateWatchingWorksJson(function(){renderWatchingWorks(),alertMessage("更新完了","info")})}),$("#clear").click(function(){StorageCache.clear(),watchingWorksJsonCache.remove(),searchWorksJsonCache.remove(),renderWatchingWorks(),renderSearchWorks(),alertMessage("クリア完了","info")})}$(function(){setupEvent($("#group-template")),watchingWorksJsonCache.get().version!=version?updateWatchingWorksJson(function(){renderWatchingWorks()}):renderWatchingWorks()});